# Task A1 - Initial access - (Log analysis) Points: 10

## Problem Statement

> We believe that the attacker may have gained access to the victim’s network by phishing a legitimate users credentials and connecting over the company’s VPN. The FBI has obtained a copy of the company’s VPN server log for the week in which the attack took place. Do any of the user accounts show unusual behavior which might indicate their credentials have been compromised?
> Note that all IP addresses have been anonymized.
> Enter the username which shows signs of a possible compromise.

Given VPN logs, we need to return a username who is seemingly malicious.
First, use Python to analyze the given file `data/vpn.log`.


```python
import pandas as pd
from datetime import datetime, timedelta
import warnings
warnings.filterwarnings('ignore')
```


```python
df = pd.read_csv("data/vpn.log")
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Node</th>
      <th>Username</th>
      <th>Start Time</th>
      <th>Duration</th>
      <th>Service</th>
      <th>Active</th>
      <th>Auth</th>
      <th>Real Ip</th>
      <th>Vpn Ip</th>
      <th>Proto</th>
      <th>Port</th>
      <th>Bytes Total</th>
      <th>Error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>openvpn-server</td>
      <td>Doris.X</td>
      <td>2022.06.27 07:48:08 EDT</td>
      <td>37494.0</td>
      <td>VPN</td>
      <td>0</td>
      <td>1</td>
      <td>172.28.168.133</td>
      <td>10.128.20.108</td>
      <td>UDP</td>
      <td>1194</td>
      <td>2.030863e+09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>openvpn-server</td>
      <td>Kelly.G</td>
      <td>2022.06.27 08:15:32 EDT</td>
      <td>32314.0</td>
      <td>VPN</td>
      <td>0</td>
      <td>1</td>
      <td>172.19.185.189</td>
      <td>10.128.20.194</td>
      <td>UDP</td>
      <td>1194</td>
      <td>2.363123e+09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>openvpn-server</td>
      <td>Dorothy.D</td>
      <td>2022.06.27 08:43:39 EDT</td>
      <td>18184.0</td>
      <td>VPN</td>
      <td>0</td>
      <td>1</td>
      <td>172.22.90.19</td>
      <td>10.128.20.43</td>
      <td>UDP</td>
      <td>1194</td>
      <td>2.009805e+09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>openvpn-server</td>
      <td>James.V</td>
      <td>2022.06.27 08:54:02 EDT</td>
      <td>2266.0</td>
      <td>VPN</td>
      <td>0</td>
      <td>1</td>
      <td>172.25.206.19</td>
      <td>10.128.20.78</td>
      <td>UDP</td>
      <td>1194</td>
      <td>1.379042e+08</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>openvpn-server</td>
      <td>Joan.P</td>
      <td>2022.06.27 09:28:35 EDT</td>
      <td>20074.0</td>
      <td>VPN</td>
      <td>0</td>
      <td>1</td>
      <td>172.23.234.95</td>
      <td>10.128.20.106</td>
      <td>UDP</td>
      <td>1194</td>
      <td>1.318902e+09</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>



This result shows `data/vpn.log`'s columns.
Some of the tables seem useless in terms of analysis, so let's remove them.


```python
df = df.drop(columns=["Node", "Service", "Active", "Proto", "Port", "Error"])
```

After this procedure, use `Start Time` and `Duration` to create a new column.
This column name should be `End Time` opposition to `Start Time`.


```python
from dateutil import parser
df[["Duration"]] = df[["Duration"]].fillna(value=0)
df['Start Time'] = pd.to_datetime(df['Start Time'])
df["Duration"] = df["Duration"].apply(lambda x: timedelta(0, x))
end_time = df["Start Time"] + df["Duration"]
df.insert(2, "End Time", end_time)
```

Let's check `Start Time` and `End Time`.
Assume you were an attacker, what do you do to deceive data? You may want to use VPN from multiple computers. See if there is an overlap between them.


```python
df = df.sort_values("Username")
usernames = df["Username"].unique()
suspect = []
for user in usernames:
    user_rows = df[df["Username"] == user]
    intervals = []
    for i, row in user_rows.iterrows():
        start_time = row["Start Time"]
        end_time = row["End Time"]
        real_ip = row["Real Ip"]
        intervals.append((start_time, end_time, real_ip))
    intervals.sort()
    # see if there is an overlap in intervals
    is_suspicious = False
    for i in range(1, len(intervals)):
        prev_left, prev_right, prev_ip = intervals[i - 1]
        cur_left, cur_right, cur_ip = intervals[i]
        if prev_left <= cur_left <= prev_right and prev_ip != cur_ip:
            is_suspicious = True
        if is_suspicious:
            suspect.append((user, prev_ip, cur_ip))
            break
print(suspect)
```

    [('Moses.K', '172.30.122.56', '172.27.26.101')]


Yes! We've found a suspicious user that has an overlap in accessing.
He seems to have enter VPN using two different IPs at the same time.

![badgea1](./img/badgea1.png)
